version: '3.8'

# ============================================================================
# DOCKER COMPOSE - PRODUCTION STACK
# Réseau Hyperledger Fabric 3.1.1 - Blockchain Foncier Côte d'Ivoire
# ============================================================================
# Ce fichier est optimisé pour un déploiement en production
# Il inclut des configurations de monitoring, healthchecks et ressources

networks:
  foncier-production:
    name: foncier-production
    driver: bridge

volumes:
  # Orderer
  orderer-production:
    name: orderer-production
  
  # Peers
  peer0-afor-production:
    name: peer0-afor-production
  peer0-cvgfr-production:
    name: peer0-cvgfr-production
  peer0-prefet-production:
    name: peer0-prefet-production
  
  # CouchDB
  couchdb-afor-production:
    name: couchdb-afor-production
  couchdb-cvgfr-production:
    name: couchdb-cvgfr-production
  couchdb-prefet-production:
    name: couchdb-prefet-production
  
  # Logs centralisés
  logs-production:
    name: logs-production

# ============================================================================
# SERVICES
# ============================================================================
services:

  # ==========================================================================
  # ORDERER
  # ==========================================================================
  orderer.foncier.ci:
    container_name: orderer.foncier.ci
    image: hyperledger/fabric-orderer:3.1.1
    labels:
      service: hyperledger-fabric
      component: orderer
    environment:
      - FABRIC_LOGGING_SPEC=${FABRIC_LOGGING_SPEC:-INFO}
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_BOOTSTRAPMETHOD=none
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
      - ORDERER_OPERATIONS_LISTENADDRESS=0.0.0.0:9443
      - ORDERER_METRICS_PROVIDER=${METRICS_PROVIDER:-prometheus}
    volumes:
      - ../network/organizations/ordererOrganizations/foncier.ci/orderers/orderer.foncier.ci/msp:/var/hyperledger/orderer/msp
      - ../network/organizations/ordererOrganizations/foncier.ci/orderers/orderer.foncier.ci/tls:/var/hyperledger/orderer/tls
      - orderer-production:/var/hyperledger/production/orderer
      - logs-production:/var/log/fabric
    ports:
      - "${ORDERER_PORT:-7050}:7050"
      - "${ORDERER_ADMIN_PORT:-7053}:7053"
      - "${ORDERER_OPERATIONS_PORT:-9443}:9443"
    networks:
      - foncier-production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9443/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ==========================================================================
  # PEER AFOR
  # ==========================================================================
  peer0.afor.foncier.ci:
    container_name: peer0.afor.foncier.ci
    image: hyperledger/fabric-peer:3.1.1
    labels:
      service: hyperledger-fabric
      component: peer
      organization: afor
    environment:
      - FABRIC_LOGGING_SPEC=${FABRIC_LOGGING_SPEC:-INFO}
      - CORE_PEER_ID=peer0.afor.foncier.ci
      - CORE_PEER_ADDRESS=peer0.afor.foncier.ci:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.afor.foncier.ci:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.afor.foncier.ci:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.afor.foncier.ci:7051
      - CORE_PEER_LOCALMSPID=AFORMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9447
      - CORE_METRICS_PROVIDER=${METRICS_PROVIDER:-prometheus}
      - CHAINCODE_AS_A_SERVICE_BUILDER_CONFIG={"peername":"peer0afor"}
      - CORE_CHAINCODE_EXECUTETIMEOUT=300s
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=foncier-production
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb-afor:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=${COUCHDB_USER:-admin}
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - ../network/organizations/peerOrganizations/afor.foncier.ci/peers/peer0.afor.foncier.ci/msp:/etc/hyperledger/fabric/msp
      - ../network/organizations/peerOrganizations/afor.foncier.ci/peers/peer0.afor.foncier.ci/tls:/etc/hyperledger/fabric/tls
      - peer0-afor-production:/var/hyperledger/production
      - /var/run/docker.sock:/host/var/run/docker.sock
      - logs-production:/var/log/fabric
    ports:
      - "${PEER_AFOR_PORT:-7051}:7051"
      - "${PEER_AFOR_OPERATIONS_PORT:-9447}:9447"
    networks:
      - foncier-production
    depends_on:
      couchdb-afor:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9447/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  couchdb-afor:
    container_name: couchdb-afor
    image: couchdb:3.3.2
    labels:
      service: hyperledger-fabric
      component: couchdb
      organization: afor
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - couchdb-afor-production:/opt/couchdb/data
    ports:
      - "${COUCHDB_AFOR_PORT:-5984}:5984"
    networks:
      - foncier-production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # PEER CVGFR
  # ==========================================================================
  peer0.cvgfr.foncier.ci:
    container_name: peer0.cvgfr.foncier.ci
    image: hyperledger/fabric-peer:3.1.1
    labels:
      service: hyperledger-fabric
      component: peer
      organization: cvgfr
    environment:
      - FABRIC_LOGGING_SPEC=${FABRIC_LOGGING_SPEC:-INFO}
      - CORE_PEER_ID=peer0.cvgfr.foncier.ci
      - CORE_PEER_ADDRESS=peer0.cvgfr.foncier.ci:8051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:8051
      - CORE_PEER_CHAINCODEADDRESS=peer0.cvgfr.foncier.ci:8052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:8052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.cvgfr.foncier.ci:8051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.cvgfr.foncier.ci:8051
      - CORE_PEER_LOCALMSPID=CVGFRMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9448
      - CORE_METRICS_PROVIDER=${METRICS_PROVIDER:-prometheus}
      - CHAINCODE_AS_A_SERVICE_BUILDER_CONFIG={"peername":"peer0cvgfr"}
      - CORE_CHAINCODE_EXECUTETIMEOUT=300s
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=foncier-production
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb-cvgfr:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=${COUCHDB_USER:-admin}
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - ../network/organizations/peerOrganizations/cvgfr.foncier.ci/peers/peer0.cvgfr.foncier.ci/msp:/etc/hyperledger/fabric/msp
      - ../network/organizations/peerOrganizations/cvgfr.foncier.ci/peers/peer0.cvgfr.foncier.ci/tls:/etc/hyperledger/fabric/tls
      - peer0-cvgfr-production:/var/hyperledger/production
      - /var/run/docker.sock:/host/var/run/docker.sock
      - logs-production:/var/log/fabric
    ports:
      - "${PEER_CVGFR_PORT:-8051}:8051"
      - "${PEER_CVGFR_OPERATIONS_PORT:-9448}:9448"
    networks:
      - foncier-production
    depends_on:
      couchdb-cvgfr:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9448/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  couchdb-cvgfr:
    container_name: couchdb-cvgfr
    image: couchdb:3.3.2
    labels:
      service: hyperledger-fabric
      component: couchdb
      organization: cvgfr
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - couchdb-cvgfr-production:/opt/couchdb/data
    ports:
      - "${COUCHDB_CVGFR_PORT:-6984}:5984"
    networks:
      - foncier-production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # PEER PREFET
  # ==========================================================================
  peer0.prefet.foncier.ci:
    container_name: peer0.prefet.foncier.ci
    image: hyperledger/fabric-peer:3.1.1
    labels:
      service: hyperledger-fabric
      component: peer
      organization: prefet
    environment:
      - FABRIC_LOGGING_SPEC=${FABRIC_LOGGING_SPEC:-INFO}
      - CORE_PEER_ID=peer0.prefet.foncier.ci
      - CORE_PEER_ADDRESS=peer0.prefet.foncier.ci:9051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:9051
      - CORE_PEER_CHAINCODEADDRESS=peer0.prefet.foncier.ci:9052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:9052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.prefet.foncier.ci:9051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.prefet.foncier.ci:9051
      - CORE_PEER_LOCALMSPID=PREFETMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9449
      - CORE_METRICS_PROVIDER=${METRICS_PROVIDER:-prometheus}
      - CHAINCODE_AS_A_SERVICE_BUILDER_CONFIG={"peername":"peer0prefet"}
      - CORE_CHAINCODE_EXECUTETIMEOUT=300s
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=foncier-production
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb-prefet:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=${COUCHDB_USER:-admin}
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - ../network/organizations/peerOrganizations/prefet.foncier.ci/peers/peer0.prefet.foncier.ci/msp:/etc/hyperledger/fabric/msp
      - ../network/organizations/peerOrganizations/prefet.foncier.ci/peers/peer0.prefet.foncier.ci/tls:/etc/hyperledger/fabric/tls
      - peer0-prefet-production:/var/hyperledger/production
      - /var/run/docker.sock:/host/var/run/docker.sock
      - logs-production:/var/log/fabric
    ports:
      - "${PEER_PREFET_PORT:-9051}:9051"
      - "${PEER_PREFET_OPERATIONS_PORT:-9449}:9449"
    networks:
      - foncier-production
    depends_on:
      couchdb-prefet:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9449/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  couchdb-prefet:
    container_name: couchdb-prefet
    image: couchdb:3.3.2
    labels:
      service: hyperledger-fabric
      component: couchdb
      organization: prefet
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-adminpw}
    volumes:
      - couchdb-prefet-production:/opt/couchdb/data
    ports:
      - "${COUCHDB_PREFET_PORT:-7984}:5984"
    networks:
      - foncier-production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # CLI
  # ==========================================================================
  cli:
    container_name: cli
    image: hyperledger/fabric-tools:3.1.1
    labels:
      service: hyperledger-fabric
      component: cli
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - FABRIC_LOGGING_SPEC=${FABRIC_LOGGING_SPEC:-INFO}
      - CORE_PEER_ID=cli
      - CORE_PEER_ADDRESS=peer0.afor.foncier.ci:7051
      - CORE_PEER_LOCALMSPID=AFORMSP
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/afor.foncier.ci/peers/peer0.afor.foncier.ci/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/afor.foncier.ci/peers/peer0.afor.foncier.ci/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/afor.foncier.ci/peers/peer0.afor.foncier.ci/tls/ca.crt
      - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/afor.foncier.ci/users/Admin@afor.foncier.ci/msp
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - ../network/organizations:/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations
      - ../chaincode:/opt/gopath/src/github.com/hyperledger/fabric/peer/chaincode
      - ../network/channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
    networks:
      - foncier-production
    depends_on:
      - orderer.foncier.ci
      - peer0.afor.foncier.ci
      - peer0.cvgfr.foncier.ci
      - peer0.prefet.foncier.ci
    restart: unless-stopped

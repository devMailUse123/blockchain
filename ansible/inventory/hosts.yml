---
# Inventaire Ansible pour déploiement Hyperledger Fabric Multi-VM
# Architecture: VMs dans un VPC privé, seule VM1 (AFOR) a une IP publique
# Communication inter-VMs via réseau privé VPC

all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.ssh/id_ed25519_blockchain_vm
    ansible_python_interpreter: /usr/bin/python3
    
    # Variables globales du réseau
    fabric_version: "3.1.1"
    ca_version: "1.5.13"
    network_name: "contrat-agraire"
    domain: "foncier.ci"
    
    # Chemins sur la machine locale
    local_project_path: "/home/absolue/my-blockchain"
    local_crypto_path: "{{ local_project_path }}/network/organizations"
    local_chaincode_path: "{{ local_project_path }}/chaincode-java/target"
    
    # Chemins sur les VMs distantes
    remote_fabric_path: "/opt/fabric"
    remote_crypto_path: "{{ remote_fabric_path }}/organizations"
    remote_chaincode_path: "{{ remote_fabric_path }}/chaincode"
    
    # Configuration CouchDB (à changer en production)
    couchdb_user: "admin"
    couchdb_password: "adminpw"
    
    # Configuration CA (à changer en production)
    ca_admin_user: "admin"
    ca_admin_password: "adminpw"
    
    # Configuration Bastion/Jump Host
    # Seule VM1 (AFOR) a une IP publique, les autres VMs sont accessibles via elle
    bastion_host: "18.194.235.149"  # IP publique de VM1
    use_bastion: true

  children:
    orderers:
      hosts:
        vm4-orderer:
          # IP privée VPC pour communication interne
          ansible_host: 10.0.3.162  # IP PRIVÉE VPC
          private_ip: 10.0.3.162    # IP utilisée par Fabric pour la communication
          
          # Configuration SSH via bastion (VM1-AFOR)
          ansible_ssh_common_args: '-o ProxyJump=ubuntu@{{ bastion_host }} -o StrictHostKeyChecking=no'
          
          orderer_port: 7050
          orderer_admin_port: 7053
          orderer_metrics_port: 9443
          ca_port: 10054
          org_name: "orderer"
          org_domain: "foncier.ci"
          msp_id: "OrdererMSP"
          
    peers:
      vars:
        # Référence à l'orderer (utilise IP PRIVÉE pour communication interne)
        orderer_address: "{{ hostvars['vm4-orderer']['private_ip'] }}"
        orderer_port: "{{ hostvars['vm4-orderer']['orderer_port'] }}"
        
      children:
        afor:
          hosts:
            vm1-afor:
              # VM1 a une IP PUBLIQUE (pour Ansible) ET une IP PRIVÉE (pour Fabric)
              ansible_host: 18.194.235.149  # IP PUBLIQUE pour SSH
              public_ip: 18.194.235.149     # IP publique (Internet)
              private_ip: 10.0.1.10         # IP PRIVÉE VPC (Fabric)
              
              # Pas de ProxyJump pour VM1 (accessible directement)
              
              peer_port: 7051
              peer_cc_port: 7052
              peer_metrics_port: 9447
              ca_port: 7054
              couchdb_port: 5984
              api_port: 3000
              org_name: "afor"
              org_domain: "afor.foncier.ci"
              msp_id: "AFOMSP"
              anchor_peer: true
              install_api: true
              has_public_ip: true  # Seule VM avec IP publique
              
        cvgfr:
          hosts:
            vm2-cvgfr:
              # IP privée VPC uniquement (accessible via VM1)
              ansible_host: 10.0.1.158  # IP PRIVÉE VPC
              private_ip: 10.0.1.158    # IP utilisée par Fabric
              
              # SSH via bastion (VM1-AFOR)
              ansible_ssh_common_args: '-o ProxyJump=ubuntu@{{ bastion_host }} -o StrictHostKeyChecking=no'
              
              peer_port: 8051
              peer_cc_port: 8052
              peer_metrics_port: 9448
              ca_port: 8054
              couchdb_port: 6984  # Mappé depuis 5984 interne
              org_name: "cvgfr"
              org_domain: "cvgfr.foncier.ci"
              msp_id: "CVGFRMSP"
              anchor_peer: true
              install_api: false
              has_public_ip: false
              
        prefet:
          hosts:
            vm3-prefet:
              # IP privée VPC uniquement (accessible via VM1)
              ansible_host: 10.0.2.245  # IP PRIVÉE VPC
              private_ip: 10.0.2.245    # IP utilisée par Fabric
              
              # SSH via bastion (VM1-AFOR)
              ansible_ssh_common_args: '-o ProxyJump=ubuntu@{{ bastion_host }} -o StrictHostKeyChecking=no'
              
              peer_port: 9051
              peer_cc_port: 9052
              peer_metrics_port: 9449
              ca_port: 9054
              couchdb_port: 7984  # Mappé depuis 5984 interne
              org_name: "prefet"
              org_domain: "prefet.foncier.ci"
              msp_id: "PrefetMSP"
              anchor_peer: true
              install_api: false
              has_public_ip: false

---
# Playbook 1: Installation de Docker et Docker Compose
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/01-install-docker.yml

- name: "Installation de Docker et Docker Compose"
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "Suppression des anciennes versions de Docker"
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
        
    - name: "Installation des dépendances Docker"
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
        
    - name: "Ajout de la clé GPG Docker"
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        keyring: /usr/share/keyrings/docker-archive-keyring.gpg
        
    - name: "Ajout du repository Docker"
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
        
    - name: "Installation de Docker"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      register: docker_install
      
    - name: "Démarrage et activation de Docker"
      systemd:
        name: docker
        state: started
        enabled: yes
        daemon_reload: yes
        
    - name: "Configuration du daemon Docker"
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "{{ docker_log_driver }}",
            "log-opts": {
              "max-size": "{{ docker_log_max_size }}",
              "max-file": "{{ docker_log_max_file }}"
            },
            "storage-driver": "overlay2",
            "features": {
              "buildkit": true
            }
          }
        mode: '0644'
      register: docker_daemon_config
      
    - name: "Redémarrage de Docker après configuration"
      systemd:
        name: docker
        state: restarted
        daemon_reload: yes
      when: docker_daemon_config.changed
      
    - name: "Attente que Docker soit prêt"
      wait_for:
        path: /var/run/docker.sock
        timeout: 60
        
    - name: "Vérification de l'installation de Docker"
      command: docker --version
      register: docker_version_output
      changed_when: false
      
    - name: "Vérification de Docker Compose"
      command: docker compose version
      register: compose_version_output
      changed_when: false
      
    - name: "Pull des images Hyperledger Fabric"
      docker_image:
        name: "{{ item }}"
        source: pull
        state: present
      loop:
        - "{{ fabric_peer_image }}"
        - "{{ fabric_orderer_image }}"
        - "{{ fabric_ca_image }}"
        - "{{ fabric_tools_image }}"
        - "{{ fabric_couchdb_image }}"
      async: 1200
      poll: 0
      register: pull_images_async
      
    - name: "Attente du téléchargement des images (peut prendre quelques minutes)"
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: pull_results
      until: pull_results.finished
      retries: 60
      delay: 20
      loop: "{{ pull_images_async.results }}"
      
    - name: "Création du réseau Docker Fabric"
      docker_network:
        name: "{{ docker_network_name }}"
        driver: bridge
        ipam_config:
          - subnet: "{{ docker_network_subnet }}"
        state: present
        
    - name: "Affichage des versions installées"
      debug:
        msg:
          - "Docker: {{ docker_version_output.stdout }}"
          - "Docker Compose: {{ compose_version_output.stdout }}"
          - "Images Fabric téléchargées: {{ pull_images_async.results | length }}"

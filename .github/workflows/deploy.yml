name: ðŸš€ Deploy Blockchain Network

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

env:
  FABRIC_VERSION: 3.1.1
  FABRIC_CA_VERSION: 1.5.15

jobs:
  # ============================================================================
  # JOB 1: VALIDATION ET TESTS
  # ============================================================================
  validate:
    name: ðŸ” Validate Configuration
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: âœ… Validate Docker Compose Files
        run: |
          docker-compose -f deploy/docker-compose-ca.yaml config > /dev/null
          docker-compose -f deploy/docker-compose.yaml config > /dev/null
          echo "âœ… Docker Compose files are valid"
      
      - name: ðŸ”Ž Lint Shell Scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          find scripts -name "*.sh" -exec shellcheck {} + || true
          echo "âœ… Shell scripts linted"
      
      - name: ðŸ“‹ Check Required Files
        run: |
          required_files=(
            "scripts/setup-ca.sh"
            "scripts/deploy-complete.sh"
            "network/configtx.yaml"
            "deploy/docker-compose.yaml"
            "deploy/docker-compose-ca.yaml"
            ".env.example"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          echo "âœ… All required files present"

  # ============================================================================
  # JOB 2: BUILD CHAINCODE
  # ============================================================================
  build-chaincode:
    name: ðŸ”¨ Build Java Chaincode
    runs-on: ubuntu-22.04
    needs: validate
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: ðŸ”¨ Build Chaincode
        working-directory: chaincode/foncier
        run: |
          chmod +x gradlew
          ./gradlew build
          echo "âœ… Chaincode built successfully"
      
      - name: ðŸ“¦ Upload Chaincode Artifact
        uses: actions/upload-artifact@v4
        with:
          name: chaincode-build
          path: chaincode/foncier/build/
          retention-days: 7

  # ============================================================================
  # JOB 3: BUILD API
  # ============================================================================
  build-api:
    name: ðŸ”¨ Build REST API
    runs-on: ubuntu-22.04
    needs: validate
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json
      
      - name: ðŸ“¥ Install Dependencies
        working-directory: api
        run: npm ci
      
      - name: ðŸ§ª Run Linter
        working-directory: api
        run: npm run lint || echo "âš ï¸  Linter warnings (non-blocking)"
      
      - name: ðŸ“¦ Upload API Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: api/
          retention-days: 7

  # ============================================================================
  # JOB 4: DEPLOY TO SERVER
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-22.04
    needs: [validate, build-chaincode, build-api]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: ðŸ“ Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸ“¤ Deploy to Server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          echo "ðŸš€ Deploying to $SERVER_USER@$SERVER_HOST:$SERVER_PORT"
          
          # CrÃ©er le rÃ©pertoire de dÃ©ploiement
          ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "mkdir -p ~/blockchain-deployment"
          
          # Synchroniser les fichiers (exclure les certificats et donnÃ©es)
          rsync -avz --delete \
            --exclude 'network/organizations/ordererOrganizations' \
            --exclude 'network/organizations/peerOrganizations' \
            --exclude 'network/channel-artifacts/*.block' \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'production' \
            --exclude '*.log' \
            -e "ssh -p $SERVER_PORT" \
            ./ $SERVER_USER@$SERVER_HOST:~/blockchain-deployment/
          
          echo "âœ… Files synchronized"
      
      - name: ðŸ”§ Configure Environment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ~/blockchain-deployment
            
            # Copier .env.example vers .env si pas existant
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "âš ï¸  Created .env from template. Please review configuration!"
            fi
            
            # Rendre les scripts exÃ©cutables
            chmod +x scripts/*.sh
            
            echo "âœ… Environment configured"
          EOF
      
      - name: ðŸ³ Deploy Network
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ~/blockchain-deployment
            
            # ArrÃªter le rÃ©seau existant (si prÃ©sent)
            if [ -f scripts/network.sh ]; then
              ./scripts/network.sh down || true
            fi
            
            # DÃ©ployer le nouveau rÃ©seau
            ./scripts/deploy-complete.sh
            
            echo "âœ… Network deployed"
          EOF
      
      - name: âœ… Verify Deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ~/blockchain-deployment
            
            # VÃ©rifier que tous les conteneurs sont en cours d'exÃ©cution
            echo "ðŸ“Š Checking container status..."
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Compter les conteneurs actifs
            RUNNING_CONTAINERS=$(docker ps -q | wc -l)
            EXPECTED_CONTAINERS=12  # 1 orderer + 3 peers + 3 couchdb + 4 CAs + 1 CLI
            
            if [ "$RUNNING_CONTAINERS" -ge "$EXPECTED_CONTAINERS" ]; then
              echo "âœ… Deployment successful: $RUNNING_CONTAINERS/$EXPECTED_CONTAINERS containers running"
            else
              echo "âš ï¸  Warning: Only $RUNNING_CONTAINERS/$EXPECTED_CONTAINERS containers running"
              exit 1
            fi
          EOF
      
      - name: ðŸ“Š Display Network Info
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ~/blockchain-deployment
            
            echo "ðŸŒ Network Information:"
            echo "======================="
            echo "Orderer: https://${{ secrets.SERVER_HOST }}:7050"
            echo "Peer AFOR: https://${{ secrets.SERVER_HOST }}:7051"
            echo "Peer CVGFR: https://${{ secrets.SERVER_HOST }}:8051"
            echo "Peer PREFET: https://${{ secrets.SERVER_HOST }}:9051"
            echo "API REST: http://${{ secrets.SERVER_HOST }}:3000"
            echo "======================="
          EOF

  # ============================================================================
  # JOB 5: NOTIFICATION
  # ============================================================================
  notify:
    name: ðŸ“¬ Send Notification
    runs-on: ubuntu-22.04
    needs: deploy
    if: always()
    
    steps:
      - name: ðŸ“§ Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Deployment successful!"
          echo "Network is running on ${{ secrets.SERVER_HOST }}"
      
      - name: ðŸ“§ Notify Failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs for details"
          exit 1
